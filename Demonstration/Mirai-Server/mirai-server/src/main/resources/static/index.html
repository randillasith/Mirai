<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirai RFID Parking System</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --secondary: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: var(--dark);
            padding-bottom: 60px; /* For mobile bottom nav */
        }

        /* Custom Card Styles */
        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }

        .card-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
        }

        /* Status Badges */
        .badge-status {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        .badge-free {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-occupied {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge-booked {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        /* Fire Alert */
        .fire-alert {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Parking Slot Cards */
        .slot-card {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .slot-card:hover {
            border-color: var(--primary);
        }

        .slot-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* Progress Bar */
        .slot-progress {
            height: 6px;
            border-radius: 3px;
            background-color: #e2e8f0;
            overflow: hidden;
        }

        .slot-progress-bar {
            height: 100%;
            transition: width 0.3s;
        }

        /* Bottom Navigation for Mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            z-index: 1000;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: #64748b;
            padding: 4px;
            transition: all 0.3s;
            border-radius: 8px;
        }

        .bottom-nav-item.active {
            color: var(--primary);
            background-color: rgba(79, 70, 229, 0.1);
        }

        .bottom-nav-item i {
            font-size: 1.25rem;
            margin-bottom: 2px;
        }

        .bottom-nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Table Responsive */
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        /* Modal Custom */
        .modal-custom .modal-content {
            border-radius: 12px;
            border: none;
        }

        /* Button Styles */
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary-custom:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            color: white;
        }

        /* Responsive Font Sizes */
        @media (max-width: 768px) {
            .display-5 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.25rem;
            }

            .card-body {
                padding: 1rem;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Toast Notification */
        .toast-container {
            z-index: 1050;
        }
    </style>
</head>

<body>
<!-- Top Header -->
<header class="bg-primary text-white py-3">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="slot-icon bg-white bg-opacity-25 me-3">
                    <i class="bi bi-p-square text-white"></i>
                </div>
                <div>
                    <h1 class="h4 mb-0 fw-bold">Mirai RFID Parking</h1>
                    <small class="opacity-75">Smart Parking Management</small>
                </div>
            </div>

            <div class="d-none d-md-flex align-items-center gap-3">
                <!-- Fire Alert Indicator -->
                <div id="fire-indicator" class="fire-alert d-none" style="cursor: pointer;" onclick="openFireModal()">
                    <i class="bi bi-fire text-warning fs-4"></i>
                </div>

                <div class="text-end">
                    <small class="opacity-75">Current Rate</small>
                    <div class="fw-bold">Rs.<span id="rate-display">0.01</span>/sec</div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Mobile Stats Bar -->
<div class="d-md-none bg-white py-2 border-bottom">
    <div class="container">
        <div class="row g-2 text-center">
            <div class="col-4">
                <small class="text-muted d-block">Available</small>
                <span class="fw-bold text-success" id="available-slots-mobile">2</span>
            </div>
            <div class="col-4">
                <small class="text-muted d-block">Active</small>
                <span class="fw-bold" id="active-count-mobile">0</span>
            </div>
            <div class="col-4">
                <small class="text-muted d-block">Rate</small>
                <span class="fw-bold">Rs.<span id="rate-mobile">0.01</span>/s</span>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<main class="container py-4">
    <!-- Dashboard Page -->
    <div id="dashboard-page">
        <!-- Stats Overview -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card card-custom h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">Total Slots</small>
                                <h4 class="fw-bold mb-0">2</h4>
                            </div>
                            <div class="slot-icon bg-primary bg-opacity-10 text-primary">
                                <i class="bi bi-p-square"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card card-custom h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">Available</small>
                                <h4 class="fw-bold text-success mb-0" id="available-slots">2</h4>
                            </div>
                            <div class="slot-icon bg-success bg-opacity-10 text-success">
                                <i class="bi bi-check-circle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card card-custom h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">Active Now</small>
                                <h4 class="fw-bold mb-0" id="active-now">0</h4>
                            </div>
                            <div class="slot-icon bg-info bg-opacity-10 text-info">
                                <i class="bi bi-car-front"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card card-custom h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">Today's Revenue</small>
                                <h4 class="fw-bold mb-0">Rs.<span id="today-revenue">0.00</span></h4>
                            </div>
                            <div class="slot-icon bg-warning bg-opacity-10 text-warning">
                                <i class="bi bi-currency-rupee"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parking Slots -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-custom">
                    <div class="card-header bg-white border-0 pb-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="slot-icon bg-primary bg-opacity-10 text-primary me-3">
                                    <i class="bi bi-p-square"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-1">Parking Slots Status</h5>
                                    <small class="text-muted">Real-time updates</small>
                                </div>
                            </div>
                            <span class="text-muted" id="last-updated">Just now</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Slot 1 -->
                            <div class="col-12 col-md-6">
                                <div id="slot1-card" class="slot-card card border h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="d-flex align-items-center">
                                                <div id="slot1-icon" class="slot-icon bg-success bg-opacity-10 text-success me-3">
                                                    <i class="bi bi-p-square"></i>
                                                </div>
                                                <div>
                                                    <h6 class="fw-bold mb-0">Slot 1</h6>
                                                    <small class="text-muted">Ground Floor</small>
                                                </div>
                                            </div>
                                            <span id="slot1-status" class="badge-status badge-free">FREE</span>
                                        </div>
                                        <p id="slot1-details" class="text-muted small mb-3">Available for parking</p>
                                        <div class="slot-progress">
                                            <div id="slot1-timer" class="slot-progress-bar bg-success" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Slot 2 -->
                            <div class="col-12 col-md-6">
                                <div id="slot2-card" class="slot-card card border h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="d-flex align-items-center">
                                                <div id="slot2-icon" class="slot-icon bg-success bg-opacity-10 text-success me-3">
                                                    <i class="bi bi-p-square"></i>
                                                </div>
                                                <div>
                                                    <h6 class="fw-bold mb-0">Slot 2</h6>
                                                    <small class="text-muted">Ground Floor</small>
                                                </div>
                                            </div>
                                            <span id="slot2-status" class="badge-status badge-free">FREE</span>
                                        </div>
                                        <p id="slot2-details" class="text-muted small mb-3">Available for parking</p>
                                        <div class="slot-progress">
                                            <div id="slot2-timer" class="slot-progress-bar bg-success" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Active Vehicles -->
        <div class="row">
            <!-- Quick Booking -->
            <div class="col-12 col-lg-4 mb-4 mb-lg-0">
                <div class="card card-custom h-100">
                    <div class="card-header bg-white border-0">
                        <h5 class="fw-bold mb-0">Quick Booking</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Vehicle ID</label>
                            <input type="text" id="book-vehicle" class="form-control" placeholder="VH-002">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Slot</label>
                            <select id="book-slot" class="form-select">
                                <option value="1">Slot 1</option>
                                <option value="2">Slot 2</option>
                            </select>
                        </div>
                        <button onclick="bookSlot()" class="btn btn-primary-custom w-100">
                            <i class="bi bi-bookmark-check me-2"></i>Book Slot
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Vehicles -->
            <div class="col-12 col-lg-8">
                <div class="card card-custom h-100">
                    <div class="card-header bg-white border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0">Active Vehicles</h5>
                            <span class="badge bg-primary" id="active-count">0 vehicles</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th>Vehicle ID</th>
                                    <th>Owner</th>
                                    <th>Duration</th>
                                    <th>Cost</th>
                                    <th>Status</th>
                                </tr>
                                </thead>
                                <tbody id="active-vehicles-body">
                                <tr>
                                    <td colspan="5" class="text-center py-5 text-muted">
                                        <i class="bi bi-car-front fs-1 opacity-25 mb-3 d-block"></i>
                                        No active vehicles
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="admin-page" class="d-none">
        <!-- Vehicle Management -->
        <div class="row">
            <div class="col-12 col-lg-8">
                <!-- Registered Vehicles -->
                <div class="card card-custom mb-4">
                    <div class="card-header bg-white border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0">Registered Vehicles</h5>
                            <span class="badge bg-primary" id="registered-count">0 vehicles</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th>Vehicle ID</th>
                                    <th>Owner</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="vehicles-body">
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Vehicle Form -->
            <div class="col-12 col-lg-4">
                <div class="card card-custom">
                    <div class="card-header bg-white border-0">
                        <h5 class="fw-bold mb-0">Register Vehicle</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Vehicle ID</label>
                            <input type="text" id="veh-id" class="form-control" placeholder="VH001" maxlength="10">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Owner Name</label>
                            <input type="text" id="owner-name" class="form-control" placeholder="John Doe">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vehicle Type</label>
                            <select id="vehicle-type" class="form-select">
                                <option value="car">Car</option>
                                <option value="bike">Motorcycle</option>
                                <option value="truck">Truck</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <button onclick="addVehicle()" class="btn btn-primary-custom w-100">
                            <i class="bi bi-plus-circle me-2"></i>Add Vehicle
                        </button>
                    </div>
                </div>

                <!-- System Settings -->
                <div class="card card-custom mt-4">
                    <div class="card-header bg-white border-0">
                        <h5 class="fw-bold mb-0">System Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Parking Rate (Rs./sec)</label>
                            <input type="number" id="admin-rate-input" class="form-control" step="0.01" min="0.01" value="0.01">
                        </div>
                        <button onclick="updateAdminRate()" class="btn btn-primary-custom w-100">
                            <i class="bi bi-save me-2"></i>Update Rate
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Page -->
    <div id="reports-page" class="d-none">
        <div class="row">
            <div class="col-12 col-lg-8">
                <div class="card card-custom">
                    <div class="card-header bg-white border-0">
                        <h5 class="fw-bold mb-0">Vehicle Reports</h5>
                    </div>
                    <div class="card-body">
                        <div id="reports-content">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <!-- Filters -->
                <div class="card card-custom mb-4">
                    <div class="card-header bg-white border-0">
                        <h5 class="fw-bold mb-0">Filters</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Date Range</label>
                            <select id="date-range" class="form-select">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vehicle Type</label>
                            <select id="vehicle-type-filter" class="form-select">
                                <option value="all">All Vehicles</option>
                                <option value="registered">Registered Only</option>
                                <option value="visitor">Visitors Only</option>
                            </select>
                        </div>
                        <button onclick="applyFilters()" class="btn btn-primary-custom w-100">
                            <i class="bi bi-funnel me-2"></i>Apply Filters
                        </button>
                    </div>
                </div>

                <!-- Export -->
                <div class="card card-custom">
                    <div class="card-header bg-white border-0">
                        <h5 class="fw-bold mb-0">Export Data</h5>
                    </div>
                    <div class="card-body">
                        <button onclick="exportCSV()" class="btn btn-outline-success w-100 mb-2">
                            <i class="bi bi-file-earmark-excel me-2"></i>Export CSV
                        </button>
                        <button onclick="exportPDF()" class="btn btn-outline-danger w-100">
                            <i class="bi bi-file-earmark-pdf me-2"></i>Export PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Desktop Navigation -->
<div class="container d-none d-lg-block mt-3">
    <div class="d-flex gap-3">
        <button class="btn btn-outline-primary" onclick="showPage('dashboard')">
            <i class="bi bi-speedometer2"></i> Dashboard
        </button>

        <button class="btn btn-outline-primary" onclick="showPage('admin')">
            <i class="bi bi-gear"></i> Admin
        </button>

        <button class="btn btn-outline-primary" onclick="showPage('reports')">
            <i class="bi bi-bar-chart"></i> Reports
        </button>
    </div>
</div>


<!-- Bottom Navigation (Mobile) -->
<nav class="bottom-nav d-lg-none">
    <div class="container">
        <div class="row">
            <div class="col-4">
                <a href="javascript:void(0)" onclick="showPage('dashboard')" class="bottom-nav-item active">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="col-4">
                <a href="javascript:void(0)" onclick="showPage('admin')" class="bottom-nav-item">

                <i class="bi bi-gear"></i>
                    <span>Admin</span>
                </a>
            </div>
            <div class="col-4">
                <a href="javascript:void(0)" onclick="showPage('reports')" class="bottom-nav-item">
                    <i class="bi bi-bar-chart"></i>
                    <span>Reports</span>
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- Fire Alert Modal -->
<div class="modal fade" id="fireModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-custom">
            <div class="modal-header border-0">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-fire me-2"></i>FIRE ALERT
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <div class="d-flex">
                        <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                        <div>
                            <h6 class="alert-heading">Fire Detected!</h6>
                            <p class="mb-1 small">Immediate attention required</p>
                        </div>
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <small class="text-muted">Status</small>
                        <p class="fw-bold" id="fire-modal-status">ACTIVE</p>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Gas Level</small>
                        <p class="fw-bold" id="fire-modal-gas">--</p>
                    </div>
                    <div class="col-12">
                        <small class="text-muted">Reason</small>
                        <p class="fw-bold" id="fire-modal-reason">--</p>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Last Update</small>
                        <p class="fw-bold" id="fire-modal-time">--</p>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Device</small>
                        <p class="fw-bold" id="fire-modal-device">--</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="ackFireUI()" data-bs-dismiss="modal">
                    <i class="bi bi-check-circle me-2"></i>Acknowledge
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i id="toast-icon" class="bi bi-info-circle-fill me-2"></i>
            <strong id="toast-title" class="me-auto">Notification</strong>
            <small>Just now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-message">
            Hello, world! This is a toast message.
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Page Navigation
    function showPage(page) {
        const pages = ['dashboard', 'admin', 'reports'];

        pages.forEach(p => {
            const el = document.getElementById(`${p}-page`);
            if (el) el.classList.add('d-none');
        });

        const activePage = document.getElementById(`${page}-page`);
        if (activePage) activePage.classList.remove('d-none');

        // Update bottom nav active state
        document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.classList.remove('active');
        });

        document.querySelectorAll(`[onclick="showPage('${page}')"]`).forEach(item => {
            item.classList.add('active');
        });

        // Load page data
        if (page === 'dashboard') refreshDashboard();
        if (page === 'admin') { loadVehicles(); loadAdminRate(); }
        if (page === 'reports') loadReports();
    }


    // Toast Notification
    function showToast(message, type = 'info', title = 'Notification') {
        const toastEl = document.getElementById('liveToast');
        const toastIcon = document.getElementById('toast-icon');
        const toastTitle = document.getElementById('toast-title');
        const toastMessage = document.getElementById('toast-message');

        let icon = 'bi-info-circle-fill';
        let color = 'text-primary';

        if (type === 'success') { icon = 'bi-check-circle-fill'; color = 'text-success'; }
        if (type === 'error') { icon = 'bi-exclamation-triangle-fill'; color = 'text-danger'; }
        if (type === 'warning') { icon = 'bi-exclamation-circle-fill'; color = 'text-warning'; }

        toastIcon.className = `${icon} ${color} me-2`;
        toastTitle.textContent = title;
        toastMessage.textContent = message;

        new bootstrap.Toast(toastEl).show();
    }

    // ================= DASHBOARD =================

    async function refreshDashboard() {
        try {
            const res = await fetch('/api/status');
            const data = await res.json();

            updateSlotStatus(1, data.slot1State);
            updateSlotStatus(2, data.slot2State);
            updateActiveVehicles(data.active);
            setFireUI(data.fire);

            document.getElementById('rate-display').textContent = data.ratePerSecond.toFixed(2);
            document.getElementById('rate-mobile').textContent = data.ratePerSecond.toFixed(2);

            document.getElementById('last-updated').textContent =
                new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        } catch (error) {
            console.error(error);
            showToast('Failed to load dashboard', 'error');
        }
    }

    function updateSlotStatus(slot, state) {
        const status = document.getElementById(`slot${slot}-status`);
        const icon = document.getElementById(`slot${slot}-icon`);
        const details = document.getElementById(`slot${slot}-details`);

        status.className = 'badge-status';
        status.textContent = state;

        if (state === 'OCCUPIED') {
            status.classList.add('badge-occupied');
            icon.className = 'slot-icon bg-danger bg-opacity-10 text-danger me-3';
            details.textContent = 'Vehicle parked';
        }
        else if (state === 'BOOKED') {
            status.classList.add('badge-booked');
            icon.className = 'slot-icon bg-warning bg-opacity-10 text-warning me-3';
            details.textContent = 'Reserved - waiting arrival';
        }
        else {
            status.classList.add('badge-free');
            icon.className = 'slot-icon bg-success bg-opacity-10 text-success me-3';
            details.textContent = 'Available for parking';
        }

        updateAvailableSlots();
    }

    function updateAvailableSlots() {
        const s1 = document.getElementById('slot1-status').textContent;
        const s2 = document.getElementById('slot2-status').textContent;

        let free = 0;
        if (s1 === 'FREE') free++;
        if (s2 === 'FREE') free++;

        document.getElementById('available-slots').textContent = free;
        document.getElementById('available-slots-mobile').textContent = free;
    }

    function updateActiveVehicles(vehicles) {
        const tbody = document.getElementById('active-vehicles-body');
        const activeCount = document.getElementById('active-count');
        const activeNow = document.getElementById('active-now');
        const mobile = document.getElementById('active-count-mobile');

        if (!vehicles || vehicles.length === 0) {
            tbody.innerHTML = `
                <tr><td colspan="5" class="text-center py-5 text-muted">
                    No active vehicles
                </td></tr>`;
            activeCount.textContent = '0 vehicles';
            activeNow.textContent = '0';
            mobile.textContent = '0';
            return;
        }

        let html = '';
        vehicles.forEach(v => {
            html += `
                <tr>
                    <td>${v.vehicle}</td>
                    <td>${v.ownerName || 'Visitor'}</td>
                    <td>${v.duration}s</td>
                    <td>Rs.${v.cost}</td>
                    <td><span class="badge bg-success">Parked</span></td>
                </tr>`;
        });

        tbody.innerHTML = html;
        activeCount.textContent = `${vehicles.length} vehicles`;
        activeNow.textContent = vehicles.length;
        mobile.textContent = vehicles.length;
    }

    // ================= FIRE =================

    window.fireWasActive = false;

    function setFireUI(fire) {
        const indicator = document.getElementById('fire-indicator');

        if (fire && fire.active) {
            window.fireWasActive = true;

            indicator.classList.remove('d-none');
            document.title = 'ðŸ”¥ FIRE - Mirai Parking';

            document.getElementById('fire-modal-status').textContent = 'ACTIVE';
            document.getElementById('fire-modal-gas').textContent = fire.gas || '--';
            document.getElementById('fire-modal-reason').textContent = fire.reason || '--';
            document.getElementById('fire-modal-time').textContent = fire.lastUpdate || '--';
            document.getElementById('fire-modal-device').textContent = fire.device || '--';

            new bootstrap.Modal(document.getElementById('fireModal')).show();
        } else {
            indicator.classList.add('d-none');
            document.title = 'Mirai RFID Parking System';

            if (window.fireWasActive) {
                console.log("Fire cleared â†’ refreshing page");
                window.fireWasActive = false;
                location.reload();
            }
        }
    }


    function openFireModal() {
        new bootstrap.Modal(document.getElementById('fireModal')).show();
    }

    function ackFireUI() {
        showToast('Fire alert acknowledged', 'success');
    }

    // ================= BOOKING =================

    async function bookSlot() {
        const vehicle = document.getElementById('book-vehicle').value.trim();
        const slot = document.getElementById('book-slot').value;

        if (!vehicle) {
            showToast('Enter Vehicle ID', 'warning');
            return;
        }

        try {
            const res = await fetch(`/api/book?vehicle=${vehicle}&slot=${slot}`, { method: 'POST' });
            const text = await res.text();

            showToast(text, 'success');
            document.getElementById('book-vehicle').value = '';
            refreshDashboard();

        } catch {
            showToast('Booking failed', 'error');
        }
    }

    // ================= ADMIN =================

    async function loadVehicles() {
        try {
            const res = await fetch('/api/admin/list');
            const data = await res.json();

            const tbody = document.getElementById('vehicles-body');
            const count = document.getElementById('registered-count');

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5">No vehicles</td></tr>`;
                count.textContent = '0 vehicles';
                return;
            }

            let html = '';
            data.forEach(v => {
                html += `
                    <tr>
                        <td>${v.vehicleId}</td>
                        <td>${v.ownerName || 'N/A'}</td>
                        <td><span class="badge bg-info">Car</span></td>
                        <td><span class="badge bg-success">Registered</span></td>
                        <td>
                            <button onclick="deleteVehicle('${v.vehicleId}')"
                                class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });

            tbody.innerHTML = html;
            count.textContent = `${data.length} vehicles`;

        } catch {
            showToast('Failed to load vehicles', 'error');
        }
    }

    async function addVehicle() {
        const vehicle = document.getElementById('veh-id').value.trim();
        const owner = document.getElementById('owner-name').value.trim();

        if (!vehicle) {
            showToast('Vehicle ID required', 'warning');
            return;
        }

        try {
            await fetch(`/api/admin/add?vehicle=${vehicle}&name=${owner}`);
            showToast('Vehicle added', 'success');
            document.getElementById('veh-id').value = '';
            document.getElementById('owner-name').value = '';
            loadVehicles();

        } catch {
            showToast('Add failed', 'error');
        }
    }

    async function deleteVehicle(vehicleId) {
        if (!confirm(`Delete ${vehicleId}?`)) return;

        try {
            await fetch(`/api/admin/delete?vehicle=${vehicleId}`);
            showToast('Vehicle deleted', 'success');
            loadVehicles();

        } catch {
            showToast('Delete failed', 'error');
        }
    }

    function loadAdminRate() {
        fetch('/api/status')
            .then(res => res.json())
            .then(data => {
                document.getElementById('admin-rate-input').value = data.ratePerSecond;
            });
    }

    async function updateAdminRate() {
        const rate = document.getElementById('admin-rate-input').value;

        if (!rate || rate <= 0) {
            showToast('Enter valid rate', 'warning');
            return;
        }

        try {
            await fetch(`/api/setRate?rate=${rate}`);
            showToast('Rate updated', 'success');

        } catch {
            showToast('Update failed', 'error');
        }
    }

    // ================= REPORTS =================

    async function loadReports() {
        try {
            const res = await fetch('/api/report/summary');
            const data = await res.json();

            const container = document.getElementById('reports-content');

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No reports</p>';
                return;
            }

            let html = `
        <div class="row g-3">
        `;

            data.forEach(r => {
                const avg = r.totalCost / (r.entries || 1);

                html += `
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card card-custom h-100">
                    <div class="card-body">

                        <div class="d-flex align-items-center mb-3">
                            <div class="slot-icon bg-primary bg-opacity-10 text-primary me-3">
                                <i class="bi bi-car-front"></i>
                            </div>

                            <h6 class="fw-bold mb-0">
                                <a href="javascript:void(0)"
                                   onclick="openVehicleReport('${r.vehicle}')"
                                   class="text-decoration-none text-primary">
                                   ${r.vehicle}
                                </a>
                            </h6>
                        </div>

                        <p class="mb-1">Entries: <strong>${r.entries}</strong></p>
                        <p class="mb-1">Total Time: <strong>${r.totalTime || 'N/A'}s</strong></p>
                        <p class="mb-1 text-success">
                            Total Cost: <strong>Rs.${r.totalCost.toFixed(2)}</strong>
                        </p>
                        <p class="mb-0">
                            Avg. Cost: <strong>Rs.${avg.toFixed(2)}</strong>
                        </p>

                    </div>
                </div>
            </div>
            `;
            });

            html += `</div>`;
            container.innerHTML = html;

        } catch {
            showToast('Failed to load reports', 'error');
        }
    }

    function openVehicleReport(vehicleId) {
        window.location.href = `/report-detail.html?vehicle=${vehicleId}`;
    }



    function applyFilters() {
        showToast('Filters applied', 'info');
    }

    function exportCSV() {
        showToast('Exporting CSV...', 'info');
    }

    function exportPDF() {
        showToast('Exporting PDF...', 'info');
    }

    // ================= INIT =================

    setInterval(refreshDashboard, 5000);

    document.addEventListener('DOMContentLoaded', () => {
        refreshDashboard();
    });
    document.addEventListener('DOMContentLoaded', () => {
        showPage('dashboard');
    });

</script>

</body>
</html>